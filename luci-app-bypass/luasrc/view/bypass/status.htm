<%
local dsp=require"luci.dispatcher"
local uci=luci.model.uci.cursor()
-%>

<style>
.pure-g
{
    letter-spacing: -.31em;
    text-rendering: optimizespeed;
    display: -webkit-box;
    display: -webkit-flex;
    display: -ms-flexbox;
    display: flex;
    -webkit-box-orient: horizontal;
    -webkit-box-direction: normal;
    -webkit-flex-flow: row wrap;
    -ms-flex-flow: row wrap;
    flex-flow: row wrap;
    -webkit-align-content: flex-start;
    -ms-flex-line-pack: start;
    align-content: flex-start;
    margin-bottom: 0.5rem
}

@media all and (-ms-high-contrast:none), (-ms-high-contrast:active) {

table .pure-g
{
    display: block
}
}
.opera-only :-o-prefocus, .pure-g {
word-spacing:-.43em
}

.pure-u
{
    display: inline-block;
    zoom: 1;
    letter-spacing: normal;
    word-spacing: normal;
    vertical-align: top;
    text-rendering: auto
}

.pure-g [class*=pure-u]
{
    font-family: sans-serif
}

.pure-u-1, .pure-u-1-1, .pure-u-1-12, .pure-u-1-2, .pure-u-1-24, .pure-u-1-3, .pure-u-1-4, .pure-u-1-5, .pure-u-1-6, .pure-u-1-8, .pure-u-10-24, .pure-u-11-12, .pure-u-11-24, .pure-u-12-24, .pure-u-13-24, .pure-u-14-24, .pure-u-15-24, .pure-u-16-24, .pure-u-17-24, .pure-u-18-24, .pure-u-19-24, .pure-u-2-24, .pure-u-2-3, .pure-u-2-5, .pure-u-20-24, .pure-u-21-24, .pure-u-22-24, .pure-u-23-24, .pure-u-24-24, .pure-u-3-24, .pure-u-3-4, .pure-u-3-5, .pure-u-3-8, .pure-u-4-24, .pure-u-4-5, .pure-u-5-12, .pure-u-5-24, .pure-u-5-5, .pure-u-5-6, .pure-u-5-8, .pure-u-6-24, .pure-u-7-12, .pure-u-7-24, .pure-u-7-8, .pure-u-8-24, .pure-u-9-24
{
    display: inline-block;
    zoom: 1;
    letter-spacing: normal;
    word-spacing: normal;
    vertical-align: top;
    text-rendering: auto;

}

.pure-u-1-24
{
    width: 4.1667%
}

.pure-u-1-12, .pure-u-2-24
{
    width: 8.3333%
}

.pure-u-1-8, .pure-u-3-24
{
    width: 12.5%
}

.pure-u-1-6, .pure-u-4-24
{
    width: 16.6667%
}

.pure-u-1-5
{
    width: 20%
}

.pure-u-5-24
{
    width: 20.8333%
}

.pure-u-1-4, .pure-u-6-24
{
    width: 20%
}

.pure-u-7-24
{
    width: 29.1667%
}

.pure-u-1-3, .pure-u-8-24
{
    width: 30%
}

.pure-u-3-8, .pure-u-9-24
{
    width: 37.5%
}

.pure-u-2-5
{
    width: 40%
}

.pure-u-10-24, .pure-u-5-12
{
    width: 41.6667%
}

.pure-u-11-24
{
    width: 45.8333%
}

.pure-u-1-2, .pure-u-12-24
{
    width: 50%
}

.pure-u-13-24
{
    width: 54.1667%
}

.pure-u-14-24, .pure-u-7-12
{
    width: 58.3333%
}

.pure-u-3-5
{
    width: 55%;
}

.pure-u-15-24, .pure-u-5-8
{
    width: 62.5%
}

.pure-u-16-24, .pure-u-2-3
{
    width: 66.6667%
}

.pure-u-17-24
{
    width: 70.8333%
}

.pure-u-18-24, .pure-u-3-4
{
    width: 75%
}

.pure-u-19-24
{
    width: 79.1667%
}

.pure-u-4-5
{
    width: 80%
}

.pure-u-20-24, .pure-u-5-6
{
    width: 83.3333%
}

.pure-u-21-24, .pure-u-7-8
{
    width: 87.5%
}

.pure-u-11-12, .pure-u-22-24
{
    width: 91.6667%
}

.pure-u-23-24
{
    width: 95.8333%
}

.pure-u-1, .pure-u-1-1, .pure-u-24-24, .pure-u-5-5
{
    width: 100%
}

.cbi-page-actions.control-group
{
    margin-bottom: 0.5rem;
}

.cbi-page-actions.control-group.fixed
{
    bottom: 2.9rem;
}

.block
{
    margin: 0.2rem;
    padding: 0;
    font-weight: normal;
    font-style: normal;
    line-height: 2em;

    border: 1px solid rgba(0,0,0,.05);
    border-radius: .375rem;
    box-shadow: rgba(0,0,0,0.6) 0 0 8px -5px;
}

.block:hover, .block:active
{
    box-shadow: rgba(0,0,0,0.7) 0 0 12px -5px;
}

.img-con
{
    margin: 0.5rem;
}

.green
{
    color: #2dce89;
}

.red
{
    color: #fb6340;
}

.yellow
{
    color: #fb9a05;
}

.block img
{
    width: 52px;
    height: auto;
    line-height: 2em;

}

.pure-u-5-8
{
    display: flex;
	align-items:center;
}

.block h4
{
    font-size: .9rem;
    font-weight: 600px;
    margin: 0rem;
    color: #8898aa!important;
    line-height: 2em;
    align-items: center;
    padding: 0;
}

.check
{
    cursor: pointer;
}

#check_port.pure-u-1-1 .pure-u-8-24
{
    width: 10%;
}

#check_port.pure-u-1-1 .pure-u-16-24
{
    width: 90%;
}
@media screen and (max-width:1080px) {

.block h4
{
    font-weight: normal;
}

#check_port
{
    display: none;
}

.block
{
    margin: 0.2rem;
}

.pure-u-1-4
{
    width: 30%;
}

.pure-u-1-5
{
    width: 40%;
}

.block h4
{
    margin-bottom: 0.5rem;
}
 @media screen and (max-width:480px) {
 .img-con {
 margin: 1rem;
}
 .block img {
 width: 36px;
}
</style>


<fieldset id="bypass_status_fieldset" class="cbi-section">
  <div class="pure-g status">
    <div class="pure-u-1-4">
      <div class="block pure-g">
        <div class="pure-u-2-5">
          <div class="img-con"> <img src="/luci-static/bypass/img/t1tcp.svg"> </div>
        </div>
        <div class="pure-u-3-5">
          <h4 id="tcp_status">
            <%:TCP%>
            <br />
            <span class="red">
            <%:Not Running%>
            </span></h4>
        </div>
      </div>
    </div>
    <div class="pure-u-1-4">
      <div class="block pure-g">
        <div class="pure-u-2-5">
          <div class="img-con"> <img src="/luci-static/bypass/img/t2udp.svg"> </div>
        </div>
        <div class="pure-u-3-5">
          <h4 id="udp_status">
            <%:UDP%>
            <br />
            <span class="red">
            <%:Not Running%>
            </span></h4>
        </div>
      </div>
    </div>
    <div class="pure-u-1-4">
      <div class="block pure-g">
        <div class="pure-u-2-5">
          <div class="img-con"> <img src="/luci-static/bypass/img/t3chinadns.svg"> </div>
        </div>
        <div class="pure-u-3-5">
          <h4 id="chinadns_status">ChinaDNS<br />
            <span class="red">
            <%:Not Running%>
            </span></h4>
        </div>
      </div>
    </div>
    <div class="pure-u-1-4">
      <div class="block pure-g">
        <div class="pure-u-2-5">
          <div class="img-con"> <img src="/luci-static/bypass/img/t4smartdns.svg"> </div>
        </div>
        <div class="pure-u-3-5">
          <h4 id="smartdns_status">SmartDNS<br />
            <span class="red">
            <%:Not Running%>
            </span></h4>
        </div>
      </div>
    </div>

		<div class="pure-u-1-4 check" onclick="refresh(0)">
           <div class="block pure-g">
              <div class="pure-u-2-5">

					<div class="img-con">
						<img src="/luci-static/bypass/img/t5gfw.svg">
					</div>
				</div>
                <div class="pure-u-3-5">
					<h4 id="status_refresh0"><%:GFW List Data%><br/><span id="refresh0_status" class="green"><%=luci.sys.exec("cat /tmp/bypass/gfw.list | wc -l")%><%:Records%></span></h4>
				</div>
			</div>
		</div>

		<div class="pure-u-1-4 check" onclick="refresh(1)">
           <div class="block pure-g">
              <div class="pure-u-2-5">

					<div class="img-con">
						<img src="/luci-static/bypass/img/t6ipv4.svg">
					</div>
				</div>
                <div class="pure-u-3-5">
					<h4 id="status_refresh1"><%:China IPv4 List Data%><br/><span id="refresh1_status" class="green"><%=luci.sys.exec("cat /tmp/bypass/china.txt | wc -l")%><%:Records%></span></h4>
				</div>
			</div>
		</div>
		<div class="pure-u-1-4 check" onclick="refresh(2)">
           <div class="block pure-g">
              <div class="pure-u-2-5">

					<div class="img-con">
						<img src="/luci-static/bypass/img/t7ipv6.svg">
					</div>
				</div>
                <div class="pure-u-3-5">
					<h4 id="status_refresh2"><%:China IPv6 List Data%><br/><span id="refresh2_status" class="green"><%=luci.sys.exec("cat /tmp/bypass/china_v6.txt | wc -l")%><%:Records%></span></h4>
				</div>
			</div>
		</div>

	
	    <div class="pure-u-1-4 check" onclick="check_net('baidu')">
      <div class="block pure-g">
        <div class="pure-u-2-5">
          <div class="img-con"> <img src="/luci-static/bypass/img/t8baidu.svg"> </div>
        </div>
        <div class="pure-u-3-5">
          <h4 id="status_baidu">
            <%:Baidu Delay%>
            <br/>
            <span id="baidu_status" class="yellow">
            <%:Touch Check%>
            </span></h4>
        </div>
      </div>
    </div>
    <div class="pure-u-1-4 check" onclick="check_net('google')">
      <div class="block pure-g">
        <div class="pure-u-2-5">
          <div class="img-con"> <img src="/luci-static/bypass/img/t9google.svg"> </div>
        </div>
        <div class="pure-u-3-5">
          <h4 id="status_google">
            <%:Google Delay%>
            <br/>
            <span id="google_status" class="yellow">
            <%:Touch Check%>
            </span></h4>
        </div>
      </div>
    </div>
    <div class="pure-u-1-4 check"  onclick="check_net('youtube')">
      <div class="block pure-g">
        <div class="pure-u-2-5">
          <div class="img-con"> <img src="/luci-static/bypass/img/t10youtube.svg"> </div>
        </div>
        <div class="pure-u-3-5">
          <h4 id="status_youtube">
            <%:Youtube Delay%>
            <br/>
            <span id="youtube_status" class="yellow">
            <%:Touch Check%>
            </span></h4>
        </div>
      </div>
    </div>
  </div>
  <script>

    const STATUS1_URL = '<%=url([[admin]], [[services]], [[bypass]], [[run]])%>';
    const CLIENT = '<%:Client%>';
    const GAME_MODE = '<%:Game Mode%>';
    const RUNNING = '<%:Running%>';
    const NOT_RUNNING = '<%:Not Running%>';

    XHR.poll(2, STATUS1_URL, null,
        function (x, data) {
            if (data) {
                if (data.tcp) {
                    $("#tcp_status").html(CLIENT + '<br><span class="green">' + RUNNING + '</span>');
                } else {
                    $("#tcp_status").html(CLIENT + '<br><span class="red">' + NOT_RUNNING + '</span>');
                }
                if (data.udp) {
                    $("#udp_status").html(GAME_MODE + '<br><span class="green">' + RUNNING + '</span>');
                } else {
                    $("#udp_status").html(GAME_MODE + '<br><span class="red">' + NOT_RUNNING + '</span>');
                }
                if (data.smartdns) {
                    $("#smartdns_status").html('SmartDNS<br><span class="green">' + RUNNING + '</span>');
                } else {
                    $("#smartdns_status").html('SmartDNS<br><span class="red">' + NOT_RUNNING + '</span>');
                }
                if (data.chinadns) {
                    $("#chinadns_status").html('ChinaDNS<br><span class="green">' + RUNNING + '</span>');
                } else {
                    $("#chinadns_status").html('ChinaDNS<br><span class="red">' + NOT_RUNNING + '</span>');
                }
            }
        }
    );

		function refresh(set){
			var s=document.getElementById('refresh'+set+'_status');
			if (s){
				var div=s.parentNode.parentNode.parentNode.parentNode;
				div.removeAttribute('onclick');
				s.innerHTML='<%:Refresh...%>';
				XHR.get('<%=dsp.build_url("admin/services/bypass/refresh")%>',
					{set:set},
					function(x,rv){
						if (rv.ret=="0")
							s.innerHTML='<span class="green"><%:No New data!%></font>';
						else if(rv.ret=="-1"){
							s.innerHTML='<span class="red"><%:Refresh Error!%></font>';
						}else{
							s.innerHTML='<span class="green"><%:Refresh OK!%><%:Total Records:%>'+rv.ret+'</font>';
						}
						div.setAttribute('onclick','refresh('+set+')');
					}
				);
			}
			return false;
		}

		function check_net(url){
			var s=document.getElementById(url+'_status');
			if (s){
				var div=s.parentNode.parentNode.parentNode.parentNode;
				div.removeAttribute('onclick');
				s.innerHTML='<%:Check...%>';
				XHR.get('<%=dsp.build_url("admin/services/bypass/checknet")%>',
					{url:url},
					function(x,rv){
						if (rv.ret==0){
							s.className="red";
							s.innerHTML='<%:Connect Error%>';
						}else{
							if (rv.ret<500){
								s.className="green";
							}else if (rv.ret<2000){
								s.className="yellow";
							}else{
								s.className="red";
							}
							s.innerHTML=rv.ret+" ms";
						}
						div.setAttribute('onclick','check_net("'+url+'")');
					}
				);
			}
			return false;
		}
		
setTimeout(function(){
			refresh(0)
			refresh(1)
			refresh(2)
			check_net('baidu')
			check_net('google')
			check_net('youtube')
		},500);
//]]>
</script>
</fieldset>
